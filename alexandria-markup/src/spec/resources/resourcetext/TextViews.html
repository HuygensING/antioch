<!--
  #%L
  alexandria-acceptance-tests
  =======
  Copyright (C) 2015 - 2017 Huygens ING (KNAW)
  =======
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.
  
  You should have received a copy of the GNU General Public
  License along with this program.  If not, see
  <http://www.gnu.org/licenses/gpl-3.0.html>.
  #L%
  -->
<html xmlns:c="http://www.concordion.org/2007/concordion"
      xmlns:h="http://huygens.knaw.nl/concordion-acceptance-test"
      xmlns:xsi="http://www.w3.org/1999/xhtml"
      xsi:schemaLocation="http://huygens.knaw.nl/concordion-acceptance-test
                          http://huygensing.github.io/antioch/xsd/concordion-rest.xsd">

<title>Antioch: Views on text</title>

<body data-desc="Views on text">

<div id="textview-anatomy" c:execute="clearStorage()"
     data-desc="Anatomy of a view description">
    For resource <span c:set="#id">00000000-0000-0000-0000-000000000001</span>:<br/>
    <h:request>
        Given that I have
        <h:success>successfully</h:success>
        <h:put>/resources/$id</h:put>
        the body:
        <h:jsonBody>
        {
	        "resource": {
		        "id": "$id",
		        "ref": "grotius-3160-v1"
        } }
        </h:jsonBody>
    </h:request>
    <br/>
    <h:request>
        Then I can set a view called inclusive by
        <h:put>/resources/$id/text/views/inclusive</h:put>
        the body:
        <h:jsonBody>
        {
          "textView": {
            "description": "Description of the view",
            "elements": {
              ":default": { "elementMode": "hideTag", "attributeMode": "hideAll" },
              "div"     : { "elementMode": "show",    "attributeMode": "showOnly id" },
              "p"       : { "elementMode": "show" },
              "note"    : { "elementMode": "hide" }
        } } }
        </h:jsonBody>
    </h:request>
    <h:request>
        And I can set a view called exclusive by
        <h:put>/resources/$id/text/views/exclusive</h:put>
        the body:
        <h:jsonBody>
        {
          "textView": {
            "description": "Description of the view",
            "elements": {
              ":default": { "elementMode": "show", "attributeMode" : "showAll" },
              "p"       : { "elementMode": "hideTag" },
              "hi"      : { "elementMode": "hideTag" },
              "note"    : { "elementMode": "hide" }
        } } }
        </h:jsonBody>
    </h:request>
    
    The textView definition has the following properties:
    <dl class="dl-horizontal">
      <dt><code>description</code></dt>
      <dd>optional. A text describing what the view is for.</dd>

      <dt><code>elements</code></dt>
      <dd>A map of xml element names and what to do with them in this view. With element name <code>:default</code> you can set view settings for elements not defined here. The properties are:
         <dl>
           <dt><code>elementMode</code></dt>
           <dd></dd>

           <dt><code>attributeMode</code></dt>
           <dd></dd>
           
           <dt><code>when</code></dt>
           <dd></dd>
         </dl>
      </dd>
        
    </dl>
</div>

<div id="set-including-view" c:execute="clearStorage()"
     data-desc="How do I define a view where I indicate which element tags to show?">

  Given a resource
  with id <code c:set="#resourceId">00000000-0000-0000-0000-000000000002</code>
  <span c:execute="resourceExists(#resourceId)">exists</span>,<br/>
  which has
  <span c:execute="resourceHasText(#resourceId,#text1)">text<br/>
    <code c:set="#text1">&lt;text&gt;&lt;div id=&quot;div-1&quot; ed=&quot;#someone&quot;&gt;&lt;p id=&quot;p-1&quot;&gt;Paragraph the First.&lt;/p&gt;&lt;p id=&quot;p-2&quot;&gt;Paragraph the Second.&lt;note&gt;Note the first.&lt;/note&gt;&lt;/p&gt;&lt;/div&gt;&lt;/text&gt;</code>
  </span>,<br/>
  <br/>

  <h:request>
     Then a
     <h:get>/resources/$resourceId/text/xml</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:<br/>
     <h:xmlResponse>
<![CDATA[
<text>
  <div id="div-1" ed="#someone">
    <p id="p-1">Paragraph the First.</p>
    <p id="p-2">Paragraph the Second.<note>Note the first.</note></p>
  </div>
</text>
]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>
     
    <h:request>
        When I
        <h:put>/resources/$resourceId/text/views/baselayer</h:put>
        the body:
        <h:jsonBody>
          {
            "textView": {
              "description": "The Base Layer",
              "elements": {
                ":default": { "elementMode": "hideTag", "attributeMode" : "hideAll" },
                "div"     : { "elementMode": "show", "attributeMode" : "showOnly id" },
                "p"       : { "elementMode": "show" },
                "text"    : { "elementMode": "show" },
                "note"    : { "elementMode": "hide" }
              }
          } }
        </h:jsonBody>
        using
        <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
        then I should receive
        <ul>
          <li>status <h:status>201 Created</h:status></li>
          <li>location header
              <h:location>https://{host}/resources/$resourceId/text/views/baselayer</h:location>
          </li>
	        <li>and the response body is <h:responseBody/></li>
        </ul>
    </h:request>
    <br/>

    <h:request>
        When I
        <h:get>/resources/$resourceId/text/views</h:get>,<br/>
        then I should receive
        <ul>
            <li>status
                <h:status>200 OK</h:status>
            </li>
            <li>and body
             <small>(only relevant fields shown for brevity)</small>
                <h:jsonResponse>
                [ {
                    "textView" : {
                      "id" : "baselayer",
                      "^definition" : "https://{host}/resources/$resourceId/text/views/baselayer",
                      "^xml" : "https://{host}/resources/$resourceId/text/xml?view=baselayer"
                    }
                } ]
                </h:jsonResponse>
            </li>
        </ul>
    </h:request>
    <br/>

    <h:request>
        If I then
        <h:get>/resources/$resourceId/text/views/baselayer</h:get>
        Then I should receive
        <ul>
            <li>status
                <h:status>200 OK</h:status>
            </li>
            <li>and body
                <h:jsonResponse>
                {
                  "textView": {
		                "description": "The Base Layer",
			              "elements": {
			                ":default": { "elementMode": "hideTag", "attributeMode" : "hideAll" },
			                "div"     : { "elementMode": "show", "attributeMode" : "showOnly id" },
			                "p"       : { "elementMode": "show" },
			                "text"    : { "elementMode": "show" },
			                "note"    : { "elementMode": "hide" }
		            } } }
                </h:jsonResponse>
            </li>
        </ul>
    </h:request>
    <br/>

  <h:request>
     Then a
     <h:get>/resources/$resourceId/text/xml?view=baselayer</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[
<text>
  <div id="div-1">
    <p>Paragraph the First.</p>
    <p>Paragraph the Second.</p>
  </div>
</text>
]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
</div>

<div id="view-for-subresource"
    data-desc="How is the view defined for a subresource?">
    
    <ul>
    <li>
    <h:request>
        Given the previously made resource <code>$resourceId</code> with its baselayer view, 
        if I add a subresource by  
        <h:post>/resources/$resourceId/subresources</h:post>
        the body
        <h:jsonBody>{ "subresource": { "sub": "Letter clusius-0012" } }</h:jsonBody>
        and observe status
        <h:status>201 Created</h:status>
        and a location header starting with
        <h:location type="base">https://{host}/resources/</h:location>
        and ending in a generated
        <h:location type="uuid">well-formed UUID</h:location>
        for the newly created subresource.
    </h:request>

    <div c:execute="#uuid = uuid()">In this case the generated uuid happened to be:
        <strong c:echo="#uuid"></strong>.
    </div>
    </li>
    <li>
    <h:request>
        To confirm our subresource, we
        <h:put>/resources/$uuid/state</h:put>
        the body
        <h:jsonBody>{"state": "CONFIRMED"}</h:jsonBody>
        and observe status
        <h:status>204 No Content</h:status>
    </h:request>
    </li>
    <li>
    <h:request>
        When I
        <h:get>/resources/$uuid/text/views</h:get>
        Then I should receive
        <ul>
            <li>status
                <h:status>200 OK</h:status>
            </li>
            <li>and body
             <small>(only relevant fields shown for brevity)</small>
                <h:jsonResponse>
                [ {
                    "textView" : {
                      "id" : "baselayer",
                      "^definition" : "https://{host}/resources/$resourceId/text/views/baselayer",
                      "^xml" : "https://{host}/resources/$uuid/text/xml?view=baselayer"
                    }
                } ]
                </h:jsonResponse>
                (The subresource uses the baseLayerDefinition of <strong>its parent</strong> resource)
            </li>
        </ul>
    </h:request>
    </li>
    <li>
      <h:request>
        To override this baselayer view, I
        <h:put>/resources/$uuid/text/views/baselayer</h:put>
        the body:
        <h:jsonBody>
        {
	        "textView": {
	          "description": "The Base Layer for the subresource",
	          "elements": {
	            ":default": { "elementMode": "hideTag", "attributeMode" : "hideAll" },
	            "div"     : { "elementMode": "show", "attributeMode" : "showOnly ref" },
	            "p"       : { "elementMode": "show" },
	            "note"    : { "elementMode": "hide" }
        } } }
        </h:jsonBody>
        using
        <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
        then I should receive
        <ul>
          <li>status <h:status>201 Created</h:status></li>
          <li>location header
              <h:location>https://{host}/resources/$uuid/text/views/baselayer</h:location>
          </li>
          <li>and the response body is <h:responseBody/></li>
        </ul>
      </h:request>
    </li>
    <li>
    <h:request>
        Now when I
        <h:get>/resources/$uuid/text/views</h:get>,<br/>
        then I should receive
        <ul>
            <li>status
                <h:status>200 OK</h:status>
            </li>
            <li>and body
             <small>(only relevant fields shown for brevity)</small>
                <h:jsonResponse>
                [ {
                    "textView" : {
                      "id" : "baselayer",
                      "^definition" : "https://{host}/resources/$uuid/text/views/baselayer",
                      "^xml" : "https://{host}/resources/$uuid/text/xml?view=baselayer"
                    }
                } ]
                </h:jsonResponse>
                (The subresource uses <strong>its own</strong> baseLayerDefinition)
            </li>
        </ul>
    </h:request>
    </li>
  </ul>
</div>

<div id="set-excluding-view" c:execute="clearStorage()"
     data-desc="How do I define a view where I only indicate which element tags NOT to show?">

  Given a resource
  with id <code c:set="#resourceId3">00000000-0000-0000-0000-000000000003</code>
  <span c:execute="resourceExists(#resourceId3)">exists</span>,<br/>
  which has
  <span c:execute="resourceHasText(#resourceId3,#text3)">text<br/>
    <code c:set="#text3">&lt;text&gt;&lt;div id=&quot;div-1&quot; ed=&quot;#someone&quot;&gt;&lt;p id=&quot;p-1&quot;&gt;Paragraph the &lt;num n=&quot;1&quot;&gt;First&lt;/num&gt;.&lt;/p&gt;&lt;p id=&quot;p-2&quot;&gt;Paragraph the &lt;num n=&quot;2&quot;&gt;Second&lt;/num&gt;.&lt;note&gt;Note the &lt;num n=&quot;1&quot;&gt;first&lt;/num&gt;.&lt;/note&gt;&lt;/p&gt;&lt;/div&gt;&lt;/text&gt;</code>
  </span><br/>
  <br/>

  <h:request>
     Then a
     <h:get>/resources/$resourceId3/text/xml</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:<br/>
     <h:xmlResponse>
<![CDATA[
<text>
  <div id="div-1" ed="#someone">
    <p id="p-1">Paragraph the <num n="1">First</num>.</p>
    <p id="p-2">Paragraph the <num n="2">Second</num>.<note>Note the <num n="1">first</num>.</note>
    </p>
  </div>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>
     
    <h:request>
        When I
        <h:put>/resources/$resourceId3/text/views/no-num</h:put>
        the body:
        <h:jsonBody>
          {
            "textView": {
              "description": "Don't show num tags",
              "elements": {
                ":default": { "elementMode": "show", "attributeMode" : "showAll" },
                "num"     : { "elementMode": "hideTag" },
                "note"    : { "elementMode": "hide" }
              }
          } }
        </h:jsonBody>
        using
        <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
        then I should receive
        <ul>
          <li>status <h:status>201 Created</h:status></li>
          <li>location header
              <h:location>https://{host}/resources/$resourceId3/text/views/no-num</h:location>
          </li>
          <li>and the response body is <h:responseBody/></li>
        </ul>
    </h:request>
    <br/>

    <h:request>
        When I
        <h:get>/resources/$resourceId3/text/views</h:get>,<br/>
        then I should receive
        <ul>
            <li>status
                <h:status>200 OK</h:status>
            </li>
            <li>and body
             <small>(only relevant fields shown for brevity)</small>
                <h:jsonResponse>
                [ {
                    "textView" : {
                      "id" : "no-num",
                      "^definition" : "https://{host}/resources/$resourceId3/text/views/no-num",
                      "^xml" : "https://{host}/resources/$resourceId3/text/xml?view=no-num"
                    }
                } ]
                </h:jsonResponse>
            </li>
        </ul>
    </h:request>
    <br/>

    <h:request>
        If I then
        <h:get>/resources/$resourceId3/text/views/no-num</h:get>
        Then I should receive
        <ul>
            <li>status
                <h:status>200 OK</h:status>
            </li>
            <li>and body
              <h:jsonResponse>
              {
                "textView": {
	                "description": "Don't show num tags",
		              "elements": {
		                ":default": { "elementMode": "show", "attributeMode" : "showAll" },
		                "num"     : { "elementMode": "hideTag" },
		                "note"    : { "elementMode": "hide" }
	            } } }
              </h:jsonResponse>
            </li>
        </ul>
    </h:request>
    <br/>

  <h:request>
     Then a
     <h:get>/resources/$resourceId3/text/xml?view=no-num</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[
<text>
  <div id="div-1" ed="#someone">
    <p id="p-1">Paragraph the First.</p>
    <p id="p-2">Paragraph the Second.</p>
  </div>
</text>
]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
</div>

<div id="set-conditional-view" c:execute="clearStorage()"
     data-desc="How do I define a view which for a given element name only shows the elements with a given attribute/value combination?">

  Given a resource
  with id <code c:set="#resourceId4">00000000-0000-0000-0000-000000000004</code>
  <span c:execute="resourceExists(#resourceId4)">exists</span>,<br/>
  which has
  <span c:execute="resourceHasText(#resourceId4,#text4)">text<br/>
    <code c:set="#text4">&lt;text&gt;&lt;div id=&quot;div-1&quot; n=&quot;01&quot;&gt;&lt;p id=&quot;p-1a&quot; transcriber=&quot;#a&quot;&gt;It was a dark and stormy night&lt;/p&gt;&lt;p id=&quot;p-1b&quot; transcriber=&quot;#b&quot;&gt;Twas a darke &amp;amp; stormy nite&lt;/p&gt;&lt;/div&gt;&lt;/text&gt;
</code>
  </span><br/>
  <br/>

  <h:request>
     Then a
     <h:get>/resources/$resourceId4/text/xml</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:<br/>
     <h:xmlResponse>
<![CDATA[
<text>
  <div id="div-1" n="01">
    <p id="p-1a" transcriber="#a">It was a dark and stormy night</p>
    <p id="p-1b" transcriber="#b">Twas a darke &amp; stormy nite</p>
  </div>
</text>
]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>
     
    <h:request>
        When I define a view <code c:set="#view">conditional</code> by
        <h:put>/resources/$resourceId4/text/views/$view</h:put>
        the body:
        <h:jsonBody>
          {
            "textView": {
              "description": "Transcriber A preferred",
              "elements": {
                ":default": { "elementMode": "show", "attributeMode" : "showAll" },
                "div"     : {                        "attributeMode" : "showOnly ref n" },
                "p"       : { "elementMode": "hide", "when" : "attribute(transcriber).isNot('#a')" },
                "note"    : { "elementMode": "hide" }
          } } }
        </h:jsonBody>
        using
        <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
        then I should receive
        <ul>
          <li>status <h:status>201 Created</h:status></li>
          <li>location header
              <h:location>https://{host}/resources/$resourceId4/text/views/$view</h:location>
          </li>
          <li>and the response body is <h:responseBody/></li>
        </ul>
    </h:request>
    <br/>

    <h:request>
        When I
        <h:get>/resources/$resourceId4/text/views</h:get>,<br/>
        then I should receive
        <ul>
            <li>status
                <h:status>200 OK</h:status>
            </li>
            <li>and body
             <small>(only relevant fields shown for brevity)</small>
                <h:jsonResponse>
                [ {
                    "textView" : {
                      "id" : "$view",
                      "^definition" : "https://{host}/resources/$resourceId4/text/views/$view",
                      "^xml" : "https://{host}/resources/$resourceId4/text/xml?view=$view"
                    }
                } ]
                </h:jsonResponse>
            </li>
        </ul>
    </h:request>
    <br/>

    <h:request>
        If I then
        <h:get>/resources/$resourceId4/text/views/$view</h:get>
        Then I should receive
        <ul>
            <li>status
                <h:status>200 OK</h:status>
            </li>
            <li>and body
              <h:jsonResponse>
              {
                "textView": {
		              "description": "Transcriber A preferred",
		              "elements": {
		                ":default": { "elementMode": "show", "attributeMode" : "showAll" },
		                "div"     : {                        "attributeMode" : "showOnly ref n" },
		                "p"       : { "elementMode": "hide", "when" : "attribute(transcriber).isNot('#a')" },
		                "note"    : { "elementMode": "hide" }
	            } } }
              </h:jsonResponse>
            </li>
        </ul>
    </h:request>
    <br/>

  <h:request>
     Then a
     <h:get>/resources/$resourceId4/text/xml?view=$view</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[
<text>
  <div n="01">
    <p id="p-1a" transcriber="#a">It was a dark and stormy night</p>
  </div>
</text>
]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
     <code>text</code>, <code>div</code> and the first <code>p</code> are shown because the <code>:default</code> <code>elementMode</code> is <code>show</code>.<br/>
     The second <code>p</code> is ignored because the <code>when</code> condition for <code>p</code> is met.<br/>
  </h:request>
</div>

<div id="set-priority-view" c:execute="clearStorage()"
     data-desc="How do I define a view which for a given element name only shows the elements where a given attribute has one of several possible values, sorted on priority?">

  Given a resource
  with id <code c:set="#resourceId5">00000000-0000-0000-0000-000000000005</code>
  <span c:execute="resourceExists(#resourceId5)">exists</span>,<br/>
  which has
  <span c:execute="resourceHasText(#resourceId5,#text4)">text<br/>
    <code c:set="#text4">&lt;text&gt;&lt;p xml:id=&quot;p-1&quot;&gt;&lt;lang resp=&quot;#b&quot; value=&quot;it&quot;&gt;&lt;lang resp=&quot;#a&quot; value=&quot;la&quot;&gt;Maecenas consectetur odio at dolor porttitor.&lt;/lang&gt;&lt;/lang&gt;&lt;/p&gt;&lt;p xml:id=&quot;p-2&quot;&gt;&lt;lang resp=&quot;#a&quot; value=&quot;la&quot;&gt;&lt;lang resp=&quot;#b&quot; value=&quot;it&quot;&gt;Aliquam a dapibus massa.&lt;/lang&gt;&lt;/lang&gt;&lt;/p&gt;&lt;p xml:id=&quot;p-3&quot;&gt;&lt;lang resp=&quot;#b&quot; value=&quot;en&quot;&gt;&lt;lang resp=&quot;#c&quot; value=&quot;fr&quot;&gt;Aenean efficitur purus ut dui molestie fermentum.&lt;/lang&gt;&lt;/lang&gt;&lt;/p&gt;&lt;p xml:id=&quot;p-4&quot;&gt;&lt;lang resp=&quot;#c&quot; value=&quot;fr&quot;&gt;Fusce congue mauris augue.&lt;/lang&gt;&lt;/p&gt;&lt;/text&gt;</code>
  </span><br/>
  <br/>

  <h:request>
     Then a
     <h:get>/resources/$resourceId5/text/xml</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:<br/>
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1"><lang resp="#b" value="it"><lang resp="#a" value="la">Maecenas consectetur odio at dolor porttitor.</lang></lang></p>
  <p xml:id="p-2"><lang resp="#a" value="la"><lang resp="#b" value="it">Aliquam a dapibus massa.</lang></lang></p>
  <p xml:id="p-3"><lang resp="#b" value="en"><lang resp="#c" value="fr">Aenean efficitur purus ut dui molestie fermentum.</lang></lang></p>
  <p xml:id="p-4"><lang resp="#c" value="fr">Fusce congue mauris augue.</lang></p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>
     
    <h:request>
        When I define a view <code c:set="#view">prioritized</code> by
        <h:put>/resources/$resourceId5/text/views/$view</h:put>
        the body:
        <h:jsonBody>
          {
            "textView": {
              "description": "On lang, resp a preferred, b otherwise, not c",
              "elements": {
                "lang":     { "elementMode": "show", "attributeMode" : "showAll", "when" : "attribute(resp).firstOf('#a','#b')" }
          } } }
        </h:jsonBody>
        using
        <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
        then I should receive
        <ul>
          <li>status <h:status>201 Created</h:status></li>
          <li>location header
              <h:location>https://{host}/resources/$resourceId5/text/views/$view</h:location>
          </li>
          <li>and the response body is <h:responseBody/></li>
        </ul>
    </h:request>
    <br/>

    <h:request>
        When I
        <h:get>/resources/$resourceId5/text/views</h:get>,<br/>
        then I should receive
        <ul>
            <li>status
                <h:status>200 OK</h:status>
            </li>
            <li>and body
             <small>(only relevant fields shown for brevity)</small>
                <h:jsonResponse>
                [ {
                    "textView" : {
                      "id" : "$view",
                      "^definition" : "https://{host}/resources/$resourceId5/text/views/$view",
                      "^xml" : "https://{host}/resources/$resourceId5/text/xml?view=$view"
                    }
                } ]
                </h:jsonResponse>
            </li>
        </ul>
    </h:request>
    <br/>

  <h:request>
     Then a
     <h:get>/resources/$resourceId5/text/xml?view=$view</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[
<text>
  <p xml:id="p-1"><lang resp="#a" value="la">Maecenas consectetur odio at dolor porttitor.</lang></p>
  <p xml:id="p-2"><lang resp="#a" value="la">Aliquam a dapibus massa.</lang></p>
  <p xml:id="p-3"><lang resp="#b" value="en">Aenean efficitur purus ut dui molestie fermentum.</lang></p>
  <p xml:id="p-4">Fusce congue mauris augue.</p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
</div>

<div id="set-priority-view1" c:execute="clearStorage()"
     data-desc="How can I select a single element annotation with a preferred annotator?">

  Given a resource
  with id <code c:set="#resourceId6">00000000-0000-0000-0000-000000000006</code>
  <span c:execute="resourceExists(#resourceId6)">exists</span>,<br/>
  with annotators
  <span c:execute="resourceHasAnnotator(#resourceId6,#annotatorCode,#annotatorCode)"><code c:set="#annotatorCode">ckcc</code></span>,
  <span c:execute="resourceHasAnnotator(#resourceId6,#annotatorCode,#annotatorCode)"><code c:set="#annotatorCode">tool</code></span> and
  <span c:execute="resourceHasAnnotator(#resourceId6,#annotatorCode,#annotatorCode)"><code c:set="#annotatorCode">dummy</code></span>,
  and 
  <span c:execute="resourceHasText(#resourceId6,#text4)">text<br/>
    <code c:set="#text4">&lt;text&gt;&lt;p xml:id=&quot;p-1&quot;&gt;Vir clarissime,&lt;/p&gt;&lt;/text&gt;</code>
  </span><br/>
  <br/>

  <h:request>
      To define view <code c:set="#view1">view_ckcc_tool</code>, I
      <h:put>/resources/$resourceId6/text/views/$view1</h:put>
      the body:
      <h:jsonBody>
        {
          "textView": {
            "description": "view_ckcc_tool",
            "elements": {
              ":default": { "elementMode": "hideTag" },
              "text":     { "elementMode": "show", "attributeMode" : "showAll" },
              "p":        { "elementMode": "show", "attributeMode" : "showAll" },
              "lang":     { "elementMode": "show", "attributeMode" : "showAll", "when" : "attribute(resp).firstOf('#ckcc','#tool')" }
        } } }
      </h:jsonBody>
      using
      <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
      which returns
      <ul>
        <li>status <h:status>201 Created</h:status></li>
        <li>location header
            <h:location>https://{host}/resources/$resourceId6/text/views/$view1</h:location>
        </li>
        <li>and the response body is <h:responseBody/></li>
      </ul>
  </h:request>
  <br/>

  <h:request>
      To define a second view <code c:set="#view2">view_ckcc</code>, I
      <h:put>/resources/$resourceId6/text/views/$view2</h:put>
      the body:
      <h:jsonBody>
        {
          "textView": {
            "description": "view_ckcc",
            "elements": {
              ":default": { "elementMode": "hideTag" },
              "text":     { "elementMode": "show", "attributeMode" : "showAll" },
              "p":        { "elementMode": "show", "attributeMode" : "showAll" },
              "lang":     { "elementMode": "show", "attributeMode" : "showAll", "when" : "attribute(resp).firstOf('#ckcc')" }
        } } }
      </h:jsonBody>
      using
      <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
      which returns
      <ul>
        <li>status <h:status>201 Created</h:status></li>
        <li>location header
            <h:location>https://{host}/resources/$resourceId6/text/views/$view2</h:location>
        </li>
        <li>and the response body is <h:responseBody/></li>
      </ul>
  </h:request>
  <br/>

  <h:request>
      To define a third view <code c:set="#view3">view_tool</code>, I
      <h:put>/resources/$resourceId6/text/views/$view3</h:put>
      the body:
      <h:jsonBody>
        {
          "textView": {
            "description": "view_tool",
            "elements": {
              ":default": { "elementMode": "hideTag" },
              "text":     { "elementMode": "show", "attributeMode" : "showAll" },
              "p":        { "elementMode": "show", "attributeMode" : "showAll" },
              "lang":     { "elementMode": "show", "attributeMode" : "showAll", "when" : "attribute(resp).firstOf('#tool')" }
        } } }
      </h:jsonBody>
      using
      <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
      which returns
      <ul>
        <li>status <h:status>201 Created</h:status></li>
        <li>location header
            <h:location>https://{host}/resources/$resourceId6/text/views/$view3</h:location>
        </li>
        <li>and the response body is <h:responseBody/></li>
      </ul>
  </h:request>
  <br/>

  <h:request>
      To define a fourth view <code c:set="#view4">view_dummy</code>, I
      <h:put>/resources/$resourceId6/text/views/$view4</h:put>
      the body:
      <h:jsonBody>
        {
          "textView": {
            "description": "view_dummy",
            "elements": {
              ":default": { "elementMode": "hideTag" },
              "text":     { "elementMode": "show", "attributeMode" : "showAll" },
              "p":        { "elementMode": "show", "attributeMode" : "showAll" },
              "lang":     { "elementMode": "show", "attributeMode" : "showAll", "when" : "attribute(resp).firstOf('#dummy')" }
        } } }
      </h:jsonBody>
      using
      <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
      which returns
      <ul>
        <li>status <h:status>201 Created</h:status></li>
        <li>location header
            <h:location>https://{host}/resources/$resourceId6/text/views/$view4</h:location>
        </li>
        <li>and the response body is <h:responseBody/></li>
      </ul>
  </h:request>
  <br/>

  <h:request>
   When I want to annotate the element with xml:id "p-1" as annotator ckcc with name <code>lang</code> and value <code>la</code>,
   then I <h:success>successfully</h:success> <h:put>/resources/$resourceId6/text/annotations/00000000-0000-0000-0000-000000000004</h:put>
   the body:
   <h:jsonBody> 
   {
     "textAnnotation" : { 
       "name" : "lang",
       "annotator" : "ckcc",
       "attributes" : {
         "value" : "la"
       },
       "position" : {
         "xml:id" : "p-1" 
       }
   } }
   </h:jsonBody>
   using
   <h:setHeader name="Content-Type">application/json</h:setHeader>
 </h:request>

  <h:request>
    When I want to annotate the element with xml:id "p-1" as annotator tool with name <code>lang</code> and value <code>?</code>,
    then I <h:success>successfully</h:success> <h:put>/resources/$resourceId6/text/annotations/00000000-0000-0000-0000-000000000005</h:put>
    the body:
    <h:jsonBody> 
    {
      "textAnnotation" : { 
        "name" : "lang",
        "annotator" : "tool",
        "attributes" : {
          "value" : "?"
        },
        "position" : {
          "xml:id" : "p-1" 
        }
    } }
    </h:jsonBody>
    using
    <h:setHeader name="Content-Type">application/json</h:setHeader>
  </h:request>
  <br/>

  <h:request>
     Retrieving the text by
     <h:get>/resources/$resourceId6/text/xml</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:<br/>
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1"><lang value="?" resp="#tool"><lang value="la" resp="#ckcc">Vir clarissime,</lang></lang></p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>

  <h:request>
     Using view <code>view_ckcc_tool</code> by
     <h:get>/resources/$resourceId6/text/xml?view=$view1</h:get>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1"><lang value="la" resp="#ckcc">Vir clarissime,</lang></p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>

  <h:request>
     Using view <code>view_ckcc</code> by
     <h:get>/resources/$resourceId6/text/xml?view=$view2</h:get>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1"><lang value="la" resp="#ckcc">Vir clarissime,</lang></p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>
  
  <h:request>
     Using view <code>view_tool</code> by
     <h:get>/resources/$resourceId6/text/xml?view=$view3</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1"><lang value="?" resp="#tool">Vir clarissime,</lang></p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>

  <h:request>
     Using view <code>view_dummy</code> by
     <h:get>/resources/$resourceId6/text/xml?view=$view4</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1">Vir clarissime,</p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>

</div>

<div id="set-priority-view2" c:execute="clearStorage()"
     data-desc="Does it matter in which order element annotations are specified?">

  If we start with the same conditions as the previous case, so:
  Given a resource
  with id <code c:set="#resourceId7">00000000-0000-0000-0000-000000000007</code>
  <span c:execute="resourceExists(#resourceId7)">exists</span>,<br/>
  with annotators
  <span c:execute="resourceHasAnnotator(#resourceId7,#annotatorCode,#annotatorCode)"><code c:set="#annotatorCode">ckcc</code></span>,
  <span c:execute="resourceHasAnnotator(#resourceId7,#annotatorCode,#annotatorCode)"><code c:set="#annotatorCode">tool</code></span> and
  <span c:execute="resourceHasAnnotator(#resourceId7,#annotatorCode,#annotatorCode)"><code c:set="#annotatorCode">dummy</code></span>,
  and 
  <span c:execute="resourceHasText(#resourceId7,#text4)">text<br/>
    <code c:set="#text4">&lt;text&gt;&lt;p xml:id=&quot;p-1&quot;&gt;Vir clarissime,&lt;/p&gt;&lt;/text&gt;</code>
  </span><br/>
  <br/>

  <h:request>
      To define view <code c:set="#view1">view_ckcc_tool</code>, I
      <h:put>/resources/$resourceId7/text/views/$view1</h:put>
      the body:
      <h:jsonBody>
        {
          "textView": {
            "description": "view_ckcc_tool",
            "elements": {
              ":default": { "elementMode": "hideTag" },
              "text":     { "elementMode": "show", "attributeMode" : "showAll" },
              "p":        { "elementMode": "show", "attributeMode" : "showAll" },
              "lang":     { "elementMode": "show", "attributeMode" : "showAll", "when" : "attribute(resp).firstOf('#ckcc','#tool')" }
        } } }
      </h:jsonBody>
      using
      <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
      which returns
      <ul>
        <li>status <h:status>201 Created</h:status></li>
        <li>location header
            <h:location>https://{host}/resources/$resourceId7/text/views/$view1</h:location>
        </li>
        <li>and the response body is <h:responseBody/></li>
      </ul>
  </h:request>
  <br/>

  <h:request>
      To define a second view <code c:set="#view2">view_ckcc</code>, I
      <h:put>/resources/$resourceId7/text/views/$view2</h:put>
      the body:
      <h:jsonBody>
        {
          "textView": {
            "description": "view_ckcc",
            "elements": {
              ":default": { "elementMode": "hideTag" },
              "text":     { "elementMode": "show", "attributeMode" : "showAll" },
              "p":        { "elementMode": "show", "attributeMode" : "showAll" },
              "lang":     { "elementMode": "show", "attributeMode" : "showAll", "when" : "attribute(resp).firstOf('#ckcc')" }
        } } }
      </h:jsonBody>
      using
      <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
      which returns
      <ul>
        <li>status <h:status>201 Created</h:status></li>
        <li>location header
            <h:location>https://{host}/resources/$resourceId7/text/views/$view2</h:location>
        </li>
        <li>and the response body is <h:responseBody/></li>
      </ul>
  </h:request>
  <br/>

  <h:request>
      To define a third view <code c:set="#view3">view_tool</code>, I
      <h:put>/resources/$resourceId7/text/views/$view3</h:put>
      the body:
      <h:jsonBody>
        {
          "textView": {
            "description": "view_tool",
            "elements": {
              ":default": { "elementMode": "hideTag" },
              "text":     { "elementMode": "show", "attributeMode" : "showAll" },
              "p":        { "elementMode": "show", "attributeMode" : "showAll" },
              "lang":     { "elementMode": "show", "attributeMode" : "showAll", "when" : "attribute(resp).firstOf('#tool')" }
        } } }
      </h:jsonBody>
      using
      <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
      which returns
      <ul>
        <li>status <h:status>201 Created</h:status></li>
        <li>location header
            <h:location>https://{host}/resources/$resourceId7/text/views/$view3</h:location>
        </li>
        <li>and the response body is <h:responseBody/></li>
      </ul>
  </h:request>
  <br/>

  <h:request>
      To define a fourth view <code c:set="#view4">view_dummy</code>, I
      <h:put>/resources/$resourceId7/text/views/$view4</h:put>
      the body:
      <h:jsonBody>
        {
          "textView": {
            "description": "view_dummy",
            "elements": {
              ":default": { "elementMode": "hideTag" },
              "text":     { "elementMode": "show", "attributeMode" : "showAll" },
              "p":        { "elementMode": "show", "attributeMode" : "showAll" },
              "lang":     { "elementMode": "show", "attributeMode" : "showAll", "when" : "attribute(resp).firstOf('#dummy')" }
        } } }
      </h:jsonBody>
      using
      <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
      which returns
      <ul>
        <li>status <h:status>201 Created</h:status></li>
        <li>location header
            <h:location>https://{host}/resources/$resourceId7/text/views/$view4</h:location>
        </li>
        <li>and the response body is <h:responseBody/></li>
      </ul>
  </h:request>
  <br/>

  <h:request>
    If we now add the same annotations as in the previous case, but in a different order, so:
    I want to annotate the element with xml:id "p-1" as annotator tool with name <code>lang</code> and value <code>?</code>,
    so I <h:success>successfully</h:success> <h:put>/resources/$resourceId7/text/annotations/10000000-0000-0000-0000-000000000000</h:put>
    the body:
    <h:jsonBody> 
    {
      "textAnnotation" : { 
        "name" : "lang",
        "annotator" : "tool",
        "attributes" : {
          "value" : "?"
        },
        "position" : {
          "xml:id" : "p-1" 
        }
    } }
    </h:jsonBody>
    using
    <h:setHeader name="Content-Type">application/json</h:setHeader>
  </h:request>
  <br/>

  <h:request>
   When I want to annotate the element with xml:id "p-1" as annotator ckcc with name <code>lang</code> and value <code>la</code>,
   then I <h:success>successfully</h:success> <h:put>/resources/$resourceId7/text/annotations/2000000-0000-0000-0000-000000000004</h:put>
   the body:
   <h:jsonBody> 
   {
     "textAnnotation" : { 
       "name" : "lang",
       "annotator" : "ckcc",
       "attributes" : {
         "value" : "la"
       },
       "position" : {
         "xml:id" : "p-1" 
       }
   } }
   </h:jsonBody>
   using
   <h:setHeader name="Content-Type">application/json</h:setHeader>
 </h:request>


  <h:request>
     Retrieving the text by
     <h:get>/resources/$resourceId7/text/xml</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:<br/>
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1"><lang value="la" resp="#ckcc"><lang value="?" resp="#tool">Vir clarissime,</lang></lang></p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>

  <h:request>
     I expect the results of using the views to be the same as in the previous case, so:<br/>
     Using view <code>view_ckcc_tool</code> by
     <h:get>/resources/$resourceId7/text/xml?view=$view1</h:get>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1"><lang value="la" resp="#ckcc">Vir clarissime,</lang></p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>

  <h:request>
     Using view <code>view_ckcc</code> by
     <h:get>/resources/$resourceId7/text/xml?view=$view2</h:get>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1"><lang value="la" resp="#ckcc">Vir clarissime,</lang></p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>
  
  <h:request>
     Using view <code>view_tool</code> by
     <h:get>/resources/$resourceId7/text/xml?view=$view3</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1"><lang value="?" resp="#tool">Vir clarissime,</lang></p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>

  <h:request>
     Using view <code>view_dummy</code> by
     <h:get>/resources/$resourceId7/text/xml?view=$view4</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1">Vir clarissime,</p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>

</div>

<div id="set-priority-view3" c:execute="clearStorage()"
     data-desc="Can I interleave different kinds of element annotations?">

  If we again start with the same conditions as the previous 2 cases, so:
  Given a resource
  with id <code c:set="#resourceId8">00000000-0000-0000-0000-000000000008</code>
  <span c:execute="resourceExists(#resourceId8)">exists</span>,<br/>
  with annotators
  <span c:execute="resourceHasAnnotator(#resourceId8,#annotatorCode,#annotatorCode)"><code c:set="#annotatorCode">ckcc</code></span>,
  <span c:execute="resourceHasAnnotator(#resourceId8,#annotatorCode,#annotatorCode)"><code c:set="#annotatorCode">tool</code></span> and
  <span c:execute="resourceHasAnnotator(#resourceId8,#annotatorCode,#annotatorCode)"><code c:set="#annotatorCode">dummy</code></span>,
  and 
  <span c:execute="resourceHasText(#resourceId8,#text4)">text<br/>
    <code c:set="#text4">&lt;text&gt;&lt;p xml:id=&quot;p-1&quot;&gt;Vir clarissime,&lt;/p&gt;&lt;/text&gt;</code>
  </span><br/>
  <br/>

  <h:request>
      The views are the same as in the previous case, with the added requirement that the <code>type</code> element is always shown.<br/>
      To define view <code c:set="#view1">view_ckcc_tool</code>, I
      <h:put>/resources/$resourceId8/text/views/$view1</h:put>
      the body:
      <h:jsonBody>
        {
          "textView": {
            "description": "view_ckcc_tool",
            "elements": {
              ":default": { "elementMode": "hideTag" },
              "text":     { "elementMode": "show", "attributeMode" : "showAll" },
              "p":        { "elementMode": "show", "attributeMode" : "showAll" },
              "type":     { "elementMode": "show", "attributeMode" : "showAll" },
              "lang":     { "elementMode": "show", "attributeMode" : "showAll", "when" : "attribute(resp).firstOf('#ckcc','#tool')" }
        } } }
      </h:jsonBody>
      using
      <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
      which returns
      <ul>
        <li>status <h:status>201 Created</h:status></li>
        <li>location header
            <h:location>https://{host}/resources/$resourceId8/text/views/$view1</h:location>
        </li>
        <li>and the response body is <h:responseBody/></li>
      </ul>
  </h:request>
  <br/>

  <h:request>
      To define a second view <code c:set="#view2">view_ckcc</code>, I
      <h:put>/resources/$resourceId8/text/views/$view2</h:put>
      the body:
      <h:jsonBody>
        {
          "textView": {
            "description": "view_ckcc",
            "elements": {
              ":default": { "elementMode": "hideTag" },
              "text":     { "elementMode": "show", "attributeMode" : "showAll" },
              "p":        { "elementMode": "show", "attributeMode" : "showAll" },
              "type":     { "elementMode": "show", "attributeMode" : "showAll" },
              "lang":     { "elementMode": "show", "attributeMode" : "showAll", "when" : "attribute(resp).firstOf('#ckcc')" }
        } } }
      </h:jsonBody>
      using
      <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
      which returns
      <ul>
        <li>status <h:status>201 Created</h:status></li>
        <li>location header
            <h:location>https://{host}/resources/$resourceId8/text/views/$view2</h:location>
        </li>
        <li>and the response body is <h:responseBody/></li>
      </ul>
  </h:request>
  <br/>

  <h:request>
      To define a third view <code c:set="#view3">view_tool</code>, I
      <h:put>/resources/$resourceId8/text/views/$view3</h:put>
      the body:
      <h:jsonBody>
        {
          "textView": {
            "description": "view_tool",
            "elements": {
              ":default": { "elementMode": "hideTag" },
              "text":     { "elementMode": "show", "attributeMode" : "showAll" },
              "p":        { "elementMode": "show", "attributeMode" : "showAll" },
              "type":     { "elementMode": "show", "attributeMode" : "showAll" },
              "lang":     { "elementMode": "show", "attributeMode" : "showAll", "when" : "attribute(resp).firstOf('#tool')" }
        } } }
      </h:jsonBody>
      using
      <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
      which returns
      <ul>
        <li>status <h:status>201 Created</h:status></li>
        <li>location header
            <h:location>https://{host}/resources/$resourceId8/text/views/$view3</h:location>
        </li>
        <li>and the response body is <h:responseBody/></li>
      </ul>
  </h:request>
  <br/>

  <h:request>
      To define a fourth view <code c:set="#view4">view_dummy</code>, I
      <h:put>/resources/$resourceId8/text/views/$view4</h:put>
      the body:
      <h:jsonBody>
        {
          "textView": {
            "description": "view_dummy",
            "elements": {
              ":default": { "elementMode": "hideTag" },
              "text":     { "elementMode": "show", "attributeMode" : "showAll" },
              "p":        { "elementMode": "show", "attributeMode" : "showAll" },
              "type":     { "elementMode": "show", "attributeMode" : "showAll" },
              "lang":     { "elementMode": "show", "attributeMode" : "showAll", "when" : "attribute(resp).firstOf('#dummy')" }
        } } }
      </h:jsonBody>
      using
      <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
      which returns
      <ul>
        <li>status <h:status>201 Created</h:status></li>
        <li>location header
            <h:location>https://{host}/resources/$resourceId8/text/views/$view4</h:location>
        </li>
        <li>and the response body is <h:responseBody/></li>
      </ul>
  </h:request>
  <br/>

  <h:request>
    In this case we add another annotation in between the ones from the last 2 cases.<br/>

    I want to annotate the element with xml:id "p-1" as annotator ckcc with name <code>lang</code> and value <code>la</code>,
    so I <h:success>successfully</h:success> <h:put>/resources/$resourceId8/text/annotations/2000000-0000-0000-0000-000000000004</h:put>
    the body:
    <h:jsonBody> 
    {
      "textAnnotation" : { 
        "name" : "lang",
        "annotator" : "ckcc",
        "attributes" : {
          "value" : "la"
        },
        "position" : {
          "xml:id" : "p-1" 
        }
    } }
    </h:jsonBody>
    using
    <h:setHeader name="Content-Type">application/json</h:setHeader>

  </h:request>
  <br/>

  <h:request>
    I want to annotate the element with xml:id "p-1" as annotator <code>ckcc</code> with name <code>type</code> and value <code>opener</code>,
    so I <h:success>successfully</h:success> <h:put>/resources/$resourceId8/text/annotations/20000000-0000-0000-0000-000000000000</h:put>
    the body:
    <h:jsonBody> 
    {
      "textAnnotation" : { 
        "name" : "type",
        "annotator" : "ckcc",
        "attributes" : {
          "value" : "opener"
        },
        "position" : {
          "xml:id" : "p-1" 
        }
    } }
    </h:jsonBody>
    using
    <h:setHeader name="Content-Type">application/json</h:setHeader>
   </h:request>
   <br/>

  <h:request>
    I want to annotate the element with xml:id "p-1" as annotator tool with name <code>lang</code> and value <code>?</code>,
    so I <h:success>successfully</h:success> <h:put>/resources/$resourceId8/text/annotations/30000000-0000-0000-0000-000000000000</h:put>
    the body:
    <h:jsonBody> 
    {
      "textAnnotation" : { 
        "name" : "lang",
        "annotator" : "tool",
        "attributes" : {
          "value" : "?"
        },
        "position" : {
          "xml:id" : "p-1" 
        }
    } }
    </h:jsonBody>
    using
    <h:setHeader name="Content-Type">application/json</h:setHeader>
  </h:request>
  <br/>

  <h:request>
     Retrieving the text by
     <h:get>/resources/$resourceId8/text/xml</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:<br/>
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1"><lang value="?" resp="#tool"><type value="opener" resp="#ckcc"><lang value="la" resp="#ckcc">Vir clarissime,</lang></type></lang></p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>

  <h:request>
     I expect the results of using the views to be the same as in the previous case, so:<br/>
     Using view <code>view_ckcc_tool</code> by
     <h:get>/resources/$resourceId8/text/xml?view=$view1</h:get>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1"><type value="opener" resp="#ckcc"><lang value="la" resp="#ckcc">Vir clarissime,</lang></type></p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>

  <h:request>
     Using view <code>view_ckcc</code> by
     <h:get>/resources/$resourceId8/text/xml?view=$view2</h:get>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1"><type value="opener" resp="#ckcc"><lang value="la" resp="#ckcc">Vir clarissime,</lang></type></p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>
  
  <h:request>
     Using view <code>view_tool</code> by
     <h:get>/resources/$resourceId8/text/xml?view=$view3</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1"><lang value="?" resp="#tool"><type value="opener" resp="#ckcc">Vir clarissime,</type></lang></p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>

  <h:request>
     Using view <code>view_dummy</code> by
     <h:get>/resources/$resourceId8/text/xml?view=$view4</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[<text>
  <p xml:id="p-1"><type value="opener" resp="#ckcc">Vir clarissime,</type></p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
</div>

<div id="variable-use" c:execute="clearStorage()"
     data-desc="How do I use variables in a view definition?">

  Given a resource
  with id <code c:set="#resourceId9">00000000-0000-0000-0000-000000000009</code>
  <span c:execute="resourceExists(#resourceId9)">exists</span>,<br/>
  which has
  <span c:execute="resourceHasText(#resourceId9,#text4)">text<br/>
    <code c:set="#text4">&lt;text&gt;&lt;p xml:id=&quot;p-1&quot;&gt;&lt;lang resp=&quot;#b&quot; valu=&quot;it&quot;&gt;&lt;lang resp=&quot;#a&quot; value=&quot;la&quot;&gt;Maecenas consectetur odio at dolor porttitor.&lt;/lang&gt;&lt;/lang&gt;&lt;/p&gt;&lt;p xml:id=&quot;p-2&quot;&gt;&lt;lang resp=&quot;#a&quot; value=&quot;la&quot;&gt;&lt;lang resp=&quot;#b&quot; value=&quot;it&quot;&gt;Aliquam a dapibus massa.&lt;/lang&gt;&lt;/lang&gt;&lt;/p&gt;&lt;p xml:id=&quot;p-3&quot;&gt;&lt;lang resp=&quot;#b&quot; value=&quot;en&quot;&gt;&lt;lang resp=&quot;#c&quot; value=&quot;fr&quot;&gt;Aenean efficitur purus ut dui molestie fermentum.&lt;/lang&gt;&lt;/lang&gt;&lt;/p&gt;&lt;p xml:id=&quot;p-4&quot;&gt;&lt;lang resp=&quot;#c&quot; value=&quot;fr&quot;&gt;Fusce congue mauris augue.&lt;/lang&gt;&lt;/p&gt;&lt;/text&gt;</code>
  </span><br/>
  <br/>

	<h:request>
	    When I define a view <code c:set="#view">prioritized</code> by
	    <h:put>/resources/$resourceId9/text/views/$view</h:put>
	    the body:
	    <h:jsonBody>
	      {
	        "textView": {
	          "description": "On lang, priorities to add on usage",
	          "elements": {
	            "lang":     { "elementMode": "show", "attributeMode" : "showAll", "when" : "attribute({attr}).firstOf({list})" }
	      } } }
	    </h:jsonBody>
	    using
	    <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
	    then I should receive
	    <ul>
	      <li>status <h:status>201 Created</h:status></li>
	      <li>location header
	          <h:location>https://{host}/resources/$resourceId9/text/views/$view</h:location>
	      </li>
	      <li>and the response body is <h:responseBody/></li>
	    </ul>
	  I've used variables <code>attr</code> and <code>list</code> in this definition, the value of which will be set when using this view.
	</h:request>
	<br/>

  <h:request>
     Then a
     <h:get>/resources/$resourceId9/text/xml?view=$view&amp;view.attr=resp&amp;view.list='%23a','%23b'</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     (the <code>#</code> need to be url-escaped)
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[
<text>
  <p xml:id="p-1"><lang resp="#a" value="la">Maecenas consectetur odio at dolor porttitor.</lang></p>
  <p xml:id="p-2"><lang resp="#a" value="la">Aliquam a dapibus massa.</lang></p>
  <p xml:id="p-3"><lang resp="#b" value="en">Aenean efficitur purus ut dui molestie fermentum.</lang></p>
  <p xml:id="p-4">Fusce congue mauris augue.</p>
</text>]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  
  <h:request>
    We can verify what the view definition is for given value(s) for the variable(s) bij adding parameters to the query:
    When I
    <h:get>/resources/$resourceId9/text/views/prioritized?view.list='%23c','%23b'&amp;view.attr=who</h:get>
    Then I should receive
    <ul>
        <li>status
            <h:status>200 OK</h:status>
        </li>
        <li>and body
            <h:jsonResponse>
        {
          "textView": {
            "description": "On lang, priorities to add on usage",
            "elements": {
              "lang":     { "elementMode": "show", "attributeMode" : "showAll", "when" : "attribute(who).firstOf('#c','#b')" }
        } } }
            </h:jsonResponse>
        </li>
    </ul>
	</h:request>
	<br/>
</div>

<div id="set-annotation-layer-priority" c:execute="clearStorage()"
     data-desc="How do I control the nesting of annotations over the same text range?">

  Given a resource
  with id <code c:set="#resourceId10">00000000-0000-0000-0000-000000000010</code>
  <span c:execute="resourceExists(#resourceId10)">exists</span>,<br/>
  which has text
  <span c:execute="resourceHasText(#resourceId10,#text5)"><br/>
    <code c:set="#text5">&lt;text&gt;&lt;p xml:id=&quot;p-1&quot;&gt;This is a naame with an error.&lt;/p&gt;&lt;/text&gt;</code>
    and
  </span><br/>
  <span c:execute="resourceHasAnnotator(#resourceId10,#annotatorCode,#annotatorDescription)">an annotator
  with code <code c:set="#annotatorCode">ed</code> and description <code c:set="#annotatorDescription">Mr. Ed</code>  
  </span>
  <br/>
  <h:request>
    Adding 2 annotations by <h:post>/resources/$resourceId10/text/annotationbatch</h:post>
    the body:
    <h:jsonBody> 
    {
      "textAnnotationList" : [
        { "textAnnotation" :
	        {
	          "id" : "00000000-0000-0000-0001-000000000010",
		        "name" : "sic",
		        "annotator" : "ed",
		        "position" : {
		          "xml:id" : "p-1", 
		          "offset" : 11, 
		          "length" : 5
		        }
		    } },
        { "textAnnotation" :
		      {
            "id" : "00000000-0000-0000-0002-000000000010",
	          "name" : "name",
	          "annotator" : "ed",
	          "position" : {
	            "xml:id" : "p-1", 
	            "offset" : 11, 
	            "length" : 5
	          }
		    } } 
      ]
    }
    </h:jsonBody>
    using
    <h:setHeader name="Content-Type">application/json</h:setHeader>,<br/>
    then I should receive
    <ul>
      <li>status <h:status>202 Accepted</h:status></li>
      <li>location header
          <h:location>https://{host}/resources/$resourceId10/text/annotationbatch/status</h:location>
      </li>
    </ul>
  </h:request>
  <h:request>
    I confirm the batch upload by <h:get>/resources/$resourceId10/text/annotationbatch/status</h:get>
    and receive 
    <h:jsonResponse>
        {
  "textAnnotationImportStatus" : {
    "done" : true,
    "state" : "done",
    "errors" : [ ],
    "textRangeAnnotationInfoMap" : {
      "00000000-0000-0000-0001-000000000010" : {
        "textAnnotationInfo" : {
          "annotates" : "naame"
        }
      },
      "00000000-0000-0000-0002-000000000010" : {
        "textAnnotationInfo" : {
          "annotates" : "naame"
        }
      }
    }
  }
}
    </h:jsonResponse>
     
  </h:request>

  <h:request>
     Then a
     <h:get>/resources/$resourceId10/text/xml</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:<br/>
     <h:xmlResponse>
<![CDATA[
<text><p xml:id="p-1">This is a <sic resp="#ed"><name resp="#ed">naame</name></sic> with an error.</p></text>
]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>
  <br/>
     
  <h:request>
    Note that the <code>name</code> annotation is wrapped in the <code>sic</code> annotation.
    Now, suppose I want a view on the text where the <code>sic</code> annotation is wrapped in the <code>name</code> annotation instead, I must first
    <h:success>successfully</h:success>
    <h:put>/resources/$resourceId10/text/views/name-sic</h:put>
    the body:
    <h:jsonBody>
    {
      "textView": {
        "description": "wrap sic in name",
        "annotationLayers" : {
          "layer1" : ["sic"],
          "layer2" : ["name"]
        },
        "annotationLayerDepthOrder" : ["layer1","layer2"]
    } } }
    </h:jsonBody>
  </h:request>     
     
  <h:request>
     Then a
     <h:get>/resources/$resourceId10/text/xml?view=name-sic</h:get><br/>
     using
     <h:setHeader name="Accept">text/xml</h:setHeader><br/>
     <h:success>successfully</h:success>
     yields response body:
     <h:xmlResponse>
<![CDATA[
<text><p xml:id="p-1">This is a <name resp="#ed"><sic resp="#ed">naame</sic></name> with an error.</p></text>
]]>
     </h:xmlResponse>
     <small>(formatting added for increased readability)</small><br/>
  </h:request>

</div>


</body>
</html>
